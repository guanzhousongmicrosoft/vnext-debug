name: Reproduce Azure Cosmos DB Emulator vNext Issue

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Debug level (1-3, higher = more verbose)'
        required: false
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      test_scenario:
        description: 'Test scenario to run'
        required: false
        default: 'basic'
        type: choice
        options:
          - 'basic'
          - 'persistent'
          - 'ephemeral'
          - 'all'

env:
  DOTNET_VERSION: '9.0.x'
  COSMOS_EMULATOR_VERSION: 'latest'
  DEBUG_LEVEL: ${{ github.event.inputs.debug_level || '2' }}
  TEST_SCENARIO: ${{ github.event.inputs.test_scenario || 'basic' }}

jobs:
  test-windows:
    name: Test on Windows (Control Group)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install .NET Aspire workload
      run: |
        Write-Host "Installing .NET Aspire workload..."
        dotnet workload install aspire
        Write-Host "Aspire workload installed successfully"
      shell: powershell
        
    - name: Check Docker availability
      run: |
        Write-Host "Checking Docker availability..."
        docker --version
        docker info
        Write-Host "Testing Docker functionality..."
        docker run --rm hello-world
        Write-Host "Docker is available and working correctly"
      shell: powershell
      
    - name: Pull Cosmos DB Emulator image
      run: |
        Write-Host "Pre-pulling Cosmos DB emulator image..."
        docker pull mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
        Write-Host "Cosmos DB emulator image pulled successfully"
      shell: powershell
        
    - name: Run Windows test
      shell: powershell
      run: |
        try {
          Write-Host "Starting Cosmos DB emulator test..."
          $ErrorActionPreference = "Stop"
          ./scripts/test-cosmos-windows.ps1 -DebugLevel ${{ env.DEBUG_LEVEL }} -TestScenario ${{ env.TEST_SCENARIO }}
          Write-Host "Test completed successfully"
        }
        catch {
          Write-Host "Test failed with error: $($_.Exception.Message)"
          Write-Host "Stack trace: $($_.Exception.StackTrace)"
          throw
        }
        
    - name: Upload Windows logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: windows-logs
        path: logs/
        retention-days: 7

  analyze-results:
    name: Analyze Test Results
    needs: [test-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: collected-logs/
        
    - name: Analyze logs
      run: |
        chmod +x ./scripts/analyze-logs.sh
        ./scripts/analyze-logs.sh
        
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      with:
        name: analysis-results
        path: analysis/
        retention-days: 30
        
    - name: Create issue summary
      run: |
        chmod +x ./scripts/create-summary.sh
        ./scripts/create-summary.sh > $GITHUB_STEP_SUMMARY
